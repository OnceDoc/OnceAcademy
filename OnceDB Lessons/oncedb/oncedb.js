var fs=require("fs"),path=require("path"),events=require("events"),redis=require("redis"),_={extend:function(e,t){if(!t)return e;for(var n in t)e[n]=t[n];return e}},OnceDB=function(){var e={},t=new events.EventEmitter,n,r=function(e,t){if(!e&&!e.client&&!e.host&&!e.port){var r=new Error("Parameter is not completed");if(!t)throw r;t(r);return}e.client?n=e.client:(n=redis.createClient(e.port,e.host,e),e.auth&&n.auth(e.auth),e.select&&n.select(e.select),n.on("error",function(e){console.error(e.toString())})),e.schema?i(e.schema,t):t&&t()},i=function(t,n){fs.readdir(t,function(r,i){if(r){n&&n(r);return}var s=0;i.forEach(function(r){var u=path.join(t,r);fs.readFile(u,function(t,a){s++;if(t)console.error("cannot load schema",u,t);else try{r=r.replace(".json","").replace(".js","");var f=o(JSON.parse(a.toString()),r||"");e[r]=f,console.log("schema@"+r,"loaded")}catch(l){console.error("parse schema error",r,l.stack||l.message)}s==i.length&&n&&n()})})})},s=function(){return+(new Date)},o=function(e,t,n){var r=Object.keys(e),i={},o={},u;for(var a=0;a<r.length;a++){var f=r[a],l=e[f].split(";"),c={};for(var h=0;h<l.length;h++){var p=l[h].trim(),d=p,v=[];if(p){var m=p[0];if(m=='"'||m=="'")p=p.substring(1,p.length-1);p=="id"&&(u=f);var g=p.indexOf("(");if(g>0&&p.lastIndexOf(")")==p.length-1){d=p.substr(0,g).trim(),v=p.substring(g+1,p.length-1).split(",");for(var y=0;y<v.length;y++){var b=(v[y]||"").trim();try{b=new Function("return "+b)}catch(w){console.error("schema@"+t+" "+f+":"+d+" custom function error "+b+":"+w.toString())}v[y]=b}}c[d]=v,d=="unique"&&(o[f]=v),v.length<1&&(d=="keywords"?v.push("_.KW."+t+":"+f,s):d=="index"&&v.push("_.IX."+t+":"+f,s))}i[f]=c}}return n||(u||console.error("schema@"+t+" do not define ID field"),i._schema_=e,i._idField_=u,i._uniques_=o),i},u=function(t,n){if(typeof t!="string"||typeof n!="object"){console.error("oncedb@schema parameter error");return}e[t]=o(n,t)},a=function(t,n){if(typeof t!="string"||typeof n!="object"||!e[t]){console.error("oncedb@schema extend error");return}var r=o(n,t,!0);for(var i in r)e[t][i]=r[i]},f={};f.require=function(){var e=this.value;return typeof e!="undefined"},f.int=function(){var e=this.field,t=this.value,n=this.model;return t=parseInt(t),n[e]=t||0,!Number.isNaN(t)},f.max=function(e){var t=this.field,n=this.value,r=this.model;return parseFloat(n)>parseFloat(e)?!1:!0},f.min=function(e){var t=this.field,n=this.value,r=this.model;return parseFloat(n)<parseFloat(e)?!1:!0},f.maxlen=function(e){var t=this.field,n=this.value||"",r=this.model;return n.length>parseFloat(e)?!1:!0},f.minlen=function(e){var t=this.field,n=this.value,r=this.model;return n.length<parseFloat(e)?!1:!0},f.id=function(e){var t=this.field,r=this.value,i=this.model,s=this.mode,o=T.SCHEMA[this.schema]||{},u=this.done,a=(e||this.schema)+":"+r,f=o._idField_;return s=="insert"&&!o[f].sequence?(n.exists(a,function(e,t){t&&(e=e||new Error(a+' do not match "id"')),u&&u(e)}),null):!0},f.unique=function(e){var t=this.field,r=this.value,i=this.model,s=this.mode,o=T.SCHEMA[this.schema]||{},u=this.done,a=o._idField_,f=i[a];return s=="insert"||s=="update"||s=="upsert"?(n.hget(e,r,function(t,n){n!==null&&n!=f&&(t=t||new Error(e+' do not match "unique"')),u&&u(t)}),null):!0},f.sequence=function(e,t,r){var i=this.field,s=this.value,o=this.model,u=this.mode,a=T.SCHEMA[this.schema]||{},f=this.done,l=a._idField_,c=o[l];return hashName=e?this.schema+":"+e:this.schema,r=parseInt(r)||1,u=="insert"||u=="upsert"&&!c?(n.hget("_.SEQUENCE",hashName,function(n,i){if(n)return f&&f(n);var s=parseInt(i)||parseInt(t)||1,u=s+r;o[l]=e?e+"-"+u:u,f&&f()}),null):!0},f.json=function(){var e=this.field,t=this.value,n=this.model,r=typeof t;if(r=="object")return n[e]=JSON.stringify(t),!0;if(r=="string"){if(t[0]=="{"&&t[t.length-1]=="}")return!0;if(t[0]=="["&&t[t.length-1]=="]")return!0}return!1},f.array=f.json=function(){var e=this.field,t=this.value,n=this.model,r=typeof t;return r=="object"?(n[e]=JSON.stringify(t),!0):r=="string"&&t[0]=="["&&t[t.length-1]=="]"?!0:!1};var l={};l.index=function(e,t){var r=this.field,i=this.value,s=this.model,o=this.oldModel||{},u=this.mode,a=T.SCHEMA[this.schema]||{},f=this.done,l=typeof t=="undefined",c=a._idField_,h=s[c];if(!e||!r||!s||!c||typeof h=="undefined")return f&&f(new Error("schema@index parameter error")),!1;var p=e+":"+i;if(u=="remove")l?n.srem(p,h,f):n.zrem(p,h,f);else{var d=o[r];if(typeof d!="undefined"&&d!=i){var v=e+":"+d;l?n.srem(v,h):n.zrem(v,h)}if(typeof i=="undefined")return!0;l?n.sadd(p,h,function(e){e&&console.error(e),f&&f(e)}):n.zadd(p,t,h,function(e){e&&console.error(e),f&&f(e)})}return null},l.keywords=function(e,t){var r=this.field,i=(this.value||"").toString().trim(),s=this.model,o=this.oldModel||{},u=this.mode,a=this.done,f=T.SCHEMA[this.schema]||{},l=f._idField_,c=s[l],h=typeof t=="undefined";if(!e||!r||!s||!l||typeof c=="undefined")return a&&a(new Error("schema@keywords parameter error")),!1;var p,d,v,m=(o[r]||"").toString().trim(),g=n.multi();u=="remove"&&m==""&&(m=i);if(m){v=m.split(",");for(p=0;p<v.length;p++)d=v[p],d&&(key=e+":"+d,h?g.srem(key,c):g.zrem(key,c))}if(i&&u!="remove"){v=i.split(",");for(p=0;p<v.length;p++)d=v[p],d&&(key=e+":"+d,g.sadd(e,d),h?g.sadd(key,c):g.zadd(key,t,c))}return g.exec(function(e,t){if(e){console.error(e),a&&a(e);return}a&&a()}),null},l.order=function(e,t){var r=this.field,i=this.value,s=this.model,o=this.mode,u=T.SCHEMA[this.schema]||{},a=this.done,f=typeof t=="undefined",l=u._idField_,c=s[l];return!e||!r||!s||!l||typeof c=="undefined"?(a&&a(new Error("schema@order parameter error")),!1):(o=="remove"?f?n.srem(e,c,a):n.zrem(e,c,a):f?n.sadd(e,c,function(e){e&&console.error(e),a&&a(e)}):n.zadd(e,t,c,function(e){e&&console.error(e),a&&a(e)}),null)},l.sequence=function(e,t,r){var i=this.field,s=this.value,o=this.model,u=this.mode,a=T.SCHEMA[this.schema]||{},f=this.done,l=a._idField_,c=o[l]||"";hashName=e?this.schema+":"+e:this.schema,r=parseInt(r)||1;if(u=="insert"||u=="upsert"){if(typeof c=="string"){var h=c.indexOf("-");h>-1&&(c=c.substr(h+1))}return n.hset("_.SEQUENCE",hashName,c,f),null}return!0},l.unique=function(e){var t=this.field,r=this.value,i=this.model,s=this.mode,o=T.SCHEMA[this.schema]||{},u=this.done,a=o._idField_,f=i[a]||"";if(!e){var l=new Error("unique keyName is not defined");return cb&&cb(l),!1}return s=="remove"?(n.hdel(e,r,f,u),null):(n.hset(e,r,f,u),null)};var c=function(e,t){var n=(e||"").toString(),r=(t||"").toString();return n.length==r.length?n.localeCompare(r):n.length>r.length?1:-1},h=function(t,n){var r=e[t];for(var i in n){var s=n[i],o=r[i];if(!o)continue;o["int"]&&(n[i]=parseInt(s));if(o.json||o.array||o.object)try{n[i]=JSON.parse(s)}catch(u){o.array?n[i]=[]:n[i]={},console.log("parse json error",s)}}},p=function(t,n,r,i){i=i||{};var s=e[t],o=i.FUNCS||f,u=i.mode,a=i.oldModel,l;if(!s)return l=new Error("Can not found schema"+t),r&&r(l),n;if(!s._idField_)return l=new Error("ID is not defined in schema "+t),r&&r(l),n;!n[s._idField_]&&s[s._idField_].sequence&&(n[s._idField_]=null);var c;a?(c={},_.extend(c,a),_.extend(c,n)):c=n;var h=Object.keys(n),p=0,d=0,v=function(e){e&&(r&&r(e),r=null),++p>=d&&(r&&r(null),r=null)};for(var m=0;m<h.length;m++){var g=h[m],y=s[g];if(typeof y=="undefined")delete n[g];else{var b=n[g],w=Object.keys(y);for(var E=0;E<w.length;E++){var S=w[E],x=o[S],T=y[S];if(x&&T){T=T.slice();for(var N=0;N<T.length;N++){var C=T[N];C instanceof Function&&(T[N]=C.apply(c))}var k={field:g,value:n[g],model:n,oldModel:i.oldModel,mode:u,schema:t,done:v},L=x.apply(k,T);L===!1?l=new Error("schema@"+t+" "+g+":"+S+" return false, "+b):L===null&&d++}}}}return p==d&&r&&r(l),l},d=function(e,t,n){p(e,t,n,{FUNCS:l})},v=function(e,t,n){p(e,t,n,{FUNCS:l,mode:"remove"})},m=function(t,r,i,s){s=s||{};var o=function(e){if(e.length<1){i&&i(null,[]);return}var r=0,o=[],u=function(t){t&&console.error(t),++r==e.length&&(s.mode=="remove"?i&&i(null,r,p):i&&i(null,o,p))},a=function(e,r){var i=t+":"+e,a=function(e){e&&console.error(e),n.del(i,u)},f=function(e,n){if(e)console.error(e);else{if(s.mode=="remove"&&n){v(t,n,a);return}n&&(h(t,n),o[r]=n)}u()};n.hgetall(i,f)};e.forEach(a)};if(arguments.length<2){i&&i(new Error("Select error: invalid params"));return}if(r instanceof Array){o(r);return}r instanceof Function&&(s=i,i=r,r={});if(typeof r!="object"){i&&i(new Error("Condition parameter error"));return}s=s||{};var u=e[t],a=u._idField_,f=r[a],l=Object.keys(r),p=0,d=0,m=0,g=typeof s.from=="number"?s.from:0,y=typeof s.to=="number"?s.to:1e3,b=s.desc,w=function(e){e.sort(function(e,t){e.length-t.length});var t=e[0].length,n=[];for(var r=0;r<e[0].length;r++){var i=e[0][r],s=!0;for(var u=1;u<e.length;u++)e[u].indexOf(i)<0&&(s=!1,u=e.length);s&&n.push(i)}p=n.length,o(n.slice(g,y+1))},E=n.multi(),S=[],x=[],T=function(e){d++;var s=u[e];if(!s){var a=new Error("select error "+e+"@"+t+" is not defined in schema");console.error(a),i&&i(a,[]);return}var f=s.index||s.keywords;if(!f){var a=new Error("select error "+t+":"+e+" is not an index field");console.error(a),i&&i(a,[]);return}var c=f[0];c instanceof Function&&(c=c());var h=c+":"+r[e];f.length>1?(b===!0?E.zrevrange(h,g,y):E.zrange(h,g,y),x&&x.push(h),S=null):(E.smembers(h),x&&x.push(h),S&&S.push(h));if(d==l.length)if(S)S.length>1?(E.discard(),S.push(function(e,t){if(e){i&&i(e);return}p=t.length,o(t.sort().slice(g,y+1))}),n.sinter.apply(n,S)):(E.scard(h),E.exec(function(e,t){p=parseInt(t[1])||0,o(t[0]||[])}));else if(x)if(x.length>1){E.discard();var v=n.multi(),m="_.TMP_IX_"+(+(new Date)).toString(36)+(Math.random()*1e8|0).toString(36);x.unshift(m,x.length),v.zinterstore.apply(v,x),b===!0?v.zrevrange(m,g,y):v.zrange(m,g,y),v.zcard(m),v.del(m),v.exec(function(e,t){if(e){i&&i(e);return}p=parseInt(t[2])||0,o(t[1]||[])})}else E.zcard(h),E.exec(function(e,t){p=parseInt(t[1])||0,o(t[0]||[])});else E.exec(function(e,t){if(e){i&&i(e);return}idArr&&t.push(idArr),w(t)})},N=function(){var e,s;for(var o=0,a=l.length;o<a;o++){var f=l[o],c=u._uniques_[f];c&&(e=f,s=c)}if(e){var h=s.slice()[0](),p=r[e];n.hget(h,p,function(e,s){if(e){i&&i(e,[]);return}console.log("where is it",t+":"+s),n.hgetall(t+":"+s,function(e,t){if(e){i&&i(e,[]);return}var n=!0;console.log("hello there",l);for(var s=0,o=l.length;s<o;s++){var u=l[s],a=r[u];console.log(u,a,t[u]),t[u]!=a&&(n=!1)}if(n){i&&i(null,[t]);return}i&&i(null,[]);return})})}return console.log(e,s,h),e};if(l.length<1)n.keys(t+":*",function(e,n){if(e){i&&i(e);return}if(n&&n.length){var r=t+":";for(var s=0;s<n.length;s++)n[s]=n[s].replace(r,"")}n.sort(c),b&&n.reverse(),w([n])});else if(f){var C=t+":"+f;n.hgetall(C,function(e,o){if(e)return i&&i(e);h(t,o),o=o||{};for(var u=0;u<l.length;u++){var a=l[u],f=r[a];if(o[a]!=f){s.mode=="remove"?i&&i(null,0,0):i&&i(null,[],0);return}}s.mode=="remove"&&o?v(t,o,function(e){e&&console.error(e),n.del(C,i)}):(p=1,i&&i(null,[o],1))})}else N()||l.forEach(T)},g=function(t,r,i,s){var o=e[t],u=o._idField_,a=r[u],s=s||{},c=s.mode,h=function(e){p(t,r,function(s){if(s){i&&i(s);return}n.hmset(t+":"+r[u],r,function(n){if(n){i&&i(n);return}p(t,r,i,{FUNCS:l,mode:c,oldModel:e})})},{FUNCS:f,mode:c,oldModel:e})};if(c=="insert")h();else{if(!a&&c!="upsert"){i&&i(new Error("update "+t+" failed: ID is not exist"));return}var d=t+":"+a;n.hgetall(d,function(e,t){if(!t&&c!="upsert"){i&&i(e||new Error("update "+d+" failed: object doesn't exist"));return}h(t)})}},y=function(e,t,n){g(e,t,n,{mode:"insert"})},b=function(e,t,n){g(e,t,n,{mode:"upsert"})},w=function(){var e=Array.prototype.slice.call(arguments);e.length==2&&e.push(null),e.push({mode:"remove"}),m.apply(this,e)},E=function(t,n){var r=e[t]._schema_;if(!r){console.error("doesn't found schema",t);return}for(var i in n){var s=r[i],o=n[i],u=typeof o;if(s.indexOf("int"))n[i]=parseInt(o)||0;else if((s.indexOf("array")>-1||s.indexOf("json")>-1)&&u=="string")try{n[i]=JSON.parse(o||"{}")}catch(a){console.error(t,n,a);return}}return n},S=function(t,n){var r=e[t]._schema_;if(!r){console.error("doesn't found schema",t);return}for(var i in n){var s=r[i],o=n[i],u=typeof o;if((s.indexOf("array")>-1||s.indexOf("json")>-1)&&u=="object"&&o)try{n[i]=JSON.stringify(o)}catch(a){console.error(t,n,a);return}}return n},x=Object.defineProperty,T={init:r,notify:t,SCHEMA:e,schema:u,extend:a,filter:p,relate:d,removeRelate:v,parse:E,stringify:S,select:m,update:g,remove:w,insert:y,upsert:b};return x(T,"client",{get:function(){return n}}),T};module.exports=OnceDB/* Powered and Minified by OnceDoc */