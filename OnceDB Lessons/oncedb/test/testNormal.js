var oncedb=require("../oncedb")(),assert=require("assert");describe("OnceDB 测试用例",function(){var e,t;describe("装载SCHEMA，准备测试DB",function(){it("oncedb: init 装载schema",function(t){e=require("redis").createClient(),e.select(4),oncedb.init({schema:"./test/schema",client:e},function(e){if(e){console.error(e);return}assert.equal(e,null),t()})}),it("redis db: 是否为空数据库",function(e){oncedb.client.keys("*",function(t,n){assert.equal(n.length,0),e()})})}),describe("验证SCHEMA:user",function(){it('SCHEMA["user"]: 检查user是否存在',function(e){assert.equal(typeof oncedb.SCHEMA.user,"object"),e()}),it("schema:user 主键是否为username",function(e){assert.equal(oncedb.SCHEMA.user._idField_,"username"),e()})}),describe("操作USER数据",function(){var e={username:"airjd",email:"c2u@live.cn",inviter:"admin",password:"1","多余字段":!0,keywords:"所有文章",qq:0};it("oncedb:filter 能否过滤掉不存在于schema中的[多余字段]",function(t){oncedb.filter("user",e,function(n){assert.equal(e["多余字段"],undefined),assert.equal(e.keywords,undefined),t()})}),it("oncedb:insert 符合规则的用户",function(t){e.password="1234",oncedb.insert("user",e,function(e){console.log(e),assert.equal(e,null),t()})}),it("oncedb:insert 重复的用户",function(t){oncedb.insert("user",e,function(e){assert.equal(!e,!1),t()})}),it("oncedb:判断相关性插入: inviter, user_email是否存在",function(e){oncedb.client.keys("*",function(t,n){console.log(n),assert.equal(n.length,3),e()})}),it("oncedb:select 通过ID字段username查找user",function(e){oncedb.select("user",{username:"airjd"},function(t,n){assert.equal(n[0].email,"c2u@live.cn"),e()})}),it("oncedb:select 通过索引字段email查找user",function(e){oncedb.select("user",{email:"c2u@live.cn"},function(t,n){assert.equal(n[0].username,"airjd"),e()})}),it("oncedb:select 通过ID:username和索引字段email查找user",function(e){oncedb.select("user",{username:"airjd",email:"c2u@live.cn"},function(t,n){assert.equal(n[0].inviter,"admin"),e()})}),it("oncedb:select 通过索引字段email和inviter查找user(两个索引字段均无权重，为无序集合内联操作)",function(e){oncedb.select("user",{inviter:"admin",email:"c2u@live.cn"},function(t,n){assert.equal(n[0].username,"airjd"),e()})}),it("oncedb:select 通过索引字段email查找不存在的user",function(e){oncedb.select("user",{email:"c2u@live.cn2"},function(t,n){assert.equal(n.length,0),e()})}),it("oncedb:select 检测update能否新增不存在的user",function(e){var t={username:"kris",email:"c52u@live.cn",inviter:"admin",password:"0000",qq:1};oncedb.update("user",t,function(n){assert.equal(typeof n,"object"),console.log(n),oncedb.update("user",t,function(t){assert.equal(t,null),e()},{mode:"insert"})})}),it("oncedb:select 通过查找所有字段查找用户",function(e){oncedb.select("user",function(t,n){n.sort(function(e,t){return e.qq-t.qq}),assert.equal(n[0].username,"airjd"),assert.equal(n[1].username,"kris"),e()})}),it("oncedb:schema 扩展schema",function(e){oncedb.extend("user",{wexin:'index("wx", +new Date())'}),oncedb.update("user",{username:"kris",wexin:"30000000000"},function(t){assert.equal(t,null),oncedb.select("user",{wexin:"30000000000"},function(t,n){assert.equal(n[0].username,"kris"),e()})})})}),describe("操作SLIDE数据－使用定定义schema",function(){it("oncedb:schema 动态加载schema",function(e){oncedb.schema("article",{_id:"id",poster:"index('user_article')",keywords:"keywords('articlekeys', +new Date() / 60000 | 0)",title:"",content:""});var t=oncedb.SCHEMA.article;assert.equal(t._idField_,"_id"),assert.equal(t.keywords.keywords[0](),"articlekeys"),e()}),it("OnceDB:insert article",function(e){oncedb.insert("article",{_id:"1234567890",poster:"airjd",keywords:"信息技术,JavaScript,NoSQL",title:"测试用的SLIDE 标题",content:"测试用的SLIDE 内容"},function(t){oncedb.client.zrange("articlekeys:NoSQL",0,100,function(t,n){oncedb.client.smembers("articlekeys",function(t,r){assert.equal(t,null),oncedb.client.smembers("user_article:airjd",function(t,i){assert.equal(t,null),oncedb.select("article",{poster:"airjd"},function(t,s){assert.equal(t,null),assert.equal(n[0],"1234567890"),assert.equal(r.length,3),assert.equal(s[0]._id,"1234567890"),assert.equal(i[0],"1234567890"),e()})})})})})}),it("OnceDB:select article by keywords",function(e){oncedb.select("article",{keywords:"NoSQL"},function(t,n){console.log(n),assert.equal(n.length,1),assert.equal(n[0].poster,"airjd"),e()})})}),describe("测试有序集合的多条件联合查询 （即所有schema中定义的index/keywords均有权重）",function(){oncedb.schema("document",{docid:"id",poster:"index('doc_poster', +new Date())",folder:"index('doc_folder', +new Date())",keywords:"keywords('doc_keys', +new Date())",publishTime:"int; order('doc_publishTime', this.publishTime)",content:""}),it("OnceDB:insert document, 查询索引创建情况",function(e){oncedb.insert("document",{docid:"0",poster:"ourjs",folder:"root",keywords:"Java,BigData",content:"document 1"}),oncedb.insert("document",{docid:"1",poster:"ourjs",folder:"www",keywords:"Redis,NoSQL",content:"document 2"}),oncedb.insert("document",{docid:"3",poster:"airjd",folder:"var",keywords:"NoSQL",content:"document 3"},function(t){oncedb.client.zrange("doc_folder:root",0,100,function(t,n){oncedb.client.smembers("doc_keys",function(t,r){assert.equal(t,null),oncedb.client.zrange("doc_poster:ourjs",0,100,function(t,i){assert.equal(t,null),assert.equal(n.length,1),assert.equal(r.length,4),assert.equal(i.length,2),e()})})})})}),it("OnceDB: 查询带ID的document",function(e){oncedb.select("document",{docid:"3",poster:"airjd",folder:"var",keywords:"NoSQL"},function(t,n){assert.equal(t,null),assert.equal(n[0].content,"document 3"),e()})}),it("OnceDB: 查询不存在的字段 fodler （应该为folder)",function(e){oncedb.select("document",{poster:"ourjs",fodler:"www"},function(t,n){assert.equal(n.length,0),e()})}),it("OnceDB: 根据两个有权重的索引进行查询",function(e){oncedb.select("document",{poster:"ourjs",folder:"www"},function(t,n){assert.equal(n[0].docid,"1"),e()})}),it("OnceDB: 插入大量document数据以便查询",function(e){for(var t=0;t<1e3;t++)oncedb.insert("document",{docid:"TEST"+t,poster:t%2===0?"airjd":"ourjs",folder:t%3===0?"var":"tmp",keywords:(t%2===0?".NET,":"JAVA,")+(t%3===0?"NoSQL":"SQL"),content:"document "+t,publishTime:t+1e3});var n=null;oncedb.client.on("idle",function(){n&&clearTimeout(n),n=setTimeout(function(){console.log("massive document created",arguments),e()},400)})}),it("OnceDB: 查询一个条件(有序)",function(e){oncedb.select("document",{poster:"airjd"},function(t,n){assert.equal(t,null),assert.ok(n.length>1),e()})}),it("OnceDB: select 前后数据并比较",function(e){var t={poster:"airjd",folder:"var",keywords:"NoSQL"};oncedb.select("document",t,function(n,r,i){oncedb.select("document",t,function(n,s,o){oncedb.select("document",t,function(t,n,u){assert.equal(i,o,u,168),assert.equal(r[0].docid,s[s.length-1].docid),console.log(r[0]),console.log(r[200]),console.log(r[300]),e()},{from:200,to:300})},{from:0,to:1e3,desc:!0})},{from:0,to:1e3})}),it("OnceDB: order 插入新的乱序document，检测其排序",function(e){oncedb.update("document",{docid:"TEST200",publishTime:100},function(t){assert.equal(t,null),oncedb.client.zrange("doc_publishTime",0,1e3,function(t,n){assert.equal(n[0],"TEST200"),e()})})})}),describe("测试查询条件的索引均为无序集合的例子",function(){oncedb.schema("people",{uid:"id",first_name:"index('first_name')",last_name:"",gender:"index('gender')",hobby:"keywords('hobby')",joinTime:"int"}),it("OnceDB: 插入大量people数据(无序集合)",function(e){var t="白毕卞蔡曹岑常车陈成程池邓丁范方樊费冯符傅甘高葛龚古关郭韩何贺洪侯胡华黄霍姬简江姜蒋金康柯孔赖郎乐雷黎李连廉梁廖林凌刘柳龙卢鲁陆路吕罗骆马梅孟莫母穆倪宁欧区潘彭蒲皮齐戚钱强秦丘邱饶任沈盛施石时史司徒苏孙谭汤唐陶田童涂王危韦卫魏温文翁巫邬吴伍武席夏萧谢辛邢徐许薛严颜杨叶易殷尤于余俞虞元袁岳云曾詹张章赵郑钟周邹朱褚庄卓",n="一乙二十丁厂七卜人入八九几儿了力乃刀又三于干亏士工土才寸下大丈与万上小口巾山千乞川亿个勺久凡及夕丸么广亡门义之尸弓己已子卫也女飞刃习叉马乡丰王井开夫天无元专云扎艺木五支厅不太犬区历尤友匹车巨牙屯比互切瓦止少日中冈贝内水见午牛手毛气升长仁什片仆化仇币仍仅斤爪反介父从今凶分乏公仓月氏勿欠风丹匀乌凤勾文六方火为斗忆订计户",r=["音乐","画画","运动","读书","唱歌","跳舞","驾驶","外语","钓鱼","跑步","养生","游戏"];for(var i=0;i<1e3;i++){var s=Math.random()*r.length|0,o=r.slice(s,s+Math.random()*4|0);oncedb.insert("people",{uid:"u"+(i+1)*1e4,first_name:t.charAt(Math.random()*t.length),last_name:n.charAt(Math.random()*n.length),gender:i%2===0?"男":"女",hobby:o,joinTime:i+1e3})}var u;oncedb.client.on("idle",function(){u&&clearTimeout(u),u=setTimeout(function(){console.log("massive people inserted",arguments),e()},400)})}),it("OnceDB: 查询People",function(e){oncedb.select("people",{gender:"女",hobby:"唱歌"},function(t,n,r){oncedb.select("people",{gender:"女",hobby:"唱歌"},function(t,i,s){console.log("result1 len1 result2 len2",n.length,r,i.length,s),assert.equal(n.length,r),assert.equal(r,s),assert.equal(i[0].uid,n[0].uid),assert.equal(i.length,11),e()},{from:0,to:10})})}),it("OnceDB: 查询一个条件(无序)",function(e){oncedb.select("people",{gender:"男"},function(t,n){assert.equal(t,null),assert.ok(n.length>1),e()})})}),describe("测试sequence自增长的ID",function(){oncedb.schema("userInfo",{id:"id;sequence(this.gender, 1000)",gender:"minlen(1);maxlen(256);index('wf_type', +new Date())",name:"minlen(1);maxlen(256);",joinTime:"int"}),it("OnceDB: 插入自增用户数据(无序集合)",function(e){oncedb.insert("userInfo",{gender:"male",name:"Kris"},function(t){console.log("inert sequence, error",t),oncedb.insert("userInfo",{gender:"male",name:"Chris"},function(t){oncedb.insert("userInfo",{gender:"female",name:"Kathey"},function(t){assert.equal(t,null),e()})})})}),it("OnceDB: 查询用户(无序)",function(e){oncedb.select("userInfo",function(t,n){console.log("userInfo",n),n.forEach(function(e){oncedb.remove("userInfo",{id:e.id})}),oncedb.client.del("_.SEQUENCE"),assert.equal(t,null),assert.ok(n.length>1),e()})})}),describe("删除相关测试数据",function(){it("OnceDB: 清除document相关测试数据",function(e){oncedb.client.del("doc_keys"),oncedb.remove("document",{docid:"0"}),oncedb.remove("document",{docid:"1"}),oncedb.remove("document",{docid:"3"});for(var t=0;t<1e3;t++)oncedb.remove("document",{docid:"TEST"+t});var n=null;oncedb.client.on("idle",function(){n&&clearTimeout(n),n=setTimeout(function(){console.log("massive documents removed",arguments),e()},100)})}),it("OnceDB: 清除people相关测试数据",function(e){for(var t=0;t<1e3;t++)oncedb.remove("people",{uid:"u"+(t+1)*1e4});oncedb.client.del("hobby");var n=null;oncedb.client.on("idle",function(){n&&clearTimeout(n),n=setTimeout(function(){console.log("massive documents removed",arguments),e()},100)})}),it("oncedb:remove 通过索引字段删除并删除相关性",function(e){oncedb.remove("user",{inviter:"admin"},function(t,n){assert.equal(n,2),e()})}),it("oncedb:remove 检测删除文章后是否从关键字集合中移除，如 articlekeys:NoSQL",function(e){oncedb.remove("article",{poster:"airjd",keywords:"NoSQL"},function(t,n){oncedb.client.zrange("articlekeys:NoSQL",0,100,function(t,n){assert.equal(n.length,0),e()})})}),it("删除自动创建的索引后查看数据库集是否为空",function(e){oncedb.client.del("articlekeys","articlekeys:NoSQL","articlekeys:信息技术","articlekeys:JavaScript",function(){oncedb.client.keys("*",function(t,n){assert.equal(n.length,0),e()})})})})})/* Powered and Minified by OnceDoc */